import axios from "axios";

const apiKey = import.meta.env.VITE_OPENAI_API_KEY;

export async function extractEmotionAndActions(text) {
    const prompt = `
    너는 매우 섬세한 감정 분석가이자, 기획자다.
    
    아래 사용자의 일기/글에서 느껴지는 감정을 최대 5개까지 추출해줘.
    감정뿐 아니라, 글에서 드러나는 **핵심 통찰, 동기, 메타인지(예: '아침 인풋이 하루 전체의 감정 인식에 결정적이다'와 같은 자기 인식/통찰)**도 반드시 감정 리스트에 포함해줘.
    이런 통찰/메타인지도 하나의 감정(또는 감정의 원인/배경)으로 간주해서, 감정명과 함께 예시 문장, 설명을 작성해줘.
    그리고 각 감정마다 반드시 아래 3가지를 모두 포함해서 분석해줘.
    
    1. 감정명(2~3개 단어, 예: 벅참/감동, 존경/동경, 가치에 대한 열망, 자부심, 갈망 등)
    2. 그 감정이 드러나는 대표적인 문장(사용자 글에서 직접 인용, 또는 그 감정이 잘 드러나는 예시 문장)
    3. 그 감정의 본질적 설명(단순한 감정이 아니라, 내면의 상태, 동기, 맥락, 가치관, 전환점 등까지 깊이 있게 분석)
    
    그리고 각 감정에 대해, 아래와 같이 **매우 구체적이고 실천 가능한 액션리스트**를 제안해줘.
    - 감정이 긍정적이면, 그 감정을 극대화할 수 있는 루틴/실천법을, 부정적이면 회복할 수 있는 루틴/실천법을 제안해줘.
    - 액션리스트는 반드시 표 형식(액션/설명/예상 소요 시간)으로 5개 이상 제안해줘.
    - 필요하다면, 감정의 하위 카테고리(예: 기획력/창의력 등)로 나눠서 제안해줘.
    - 마지막에, 하루 루틴 예시와 핵심 팁(실행을 방해하지 않는 작은 실천의 중요성 등)도 꼭 추가해줘.


    아래와 같은 형식으로 JSON으로만 답변해줘:
    
    {
      "감정": [
        {
          "이름": "벅참 / 감동",
          "예시": ""종합예술같은 작품에 심장이 뛴다"",
          "설명": "예술적 또는 창조적 경험에서 오는 감정의 진동. 단순한 흥미가 아니라 깊은 감흥에 가까움."
        },
        {
          "이름": "존경 / 이상에 대한 동경",
          "예시": ""르코르뷔지에, 노스페이스 창업자, 뉴진스..."",
          "설명": "현실을 뛰어넘는 가치를 실현해낸 사람들에 대한 동경과 감탄."
        }
      ],
      "액션리스트": {
        "기획력과 창의력에 대한 갈망": {
      "카테고리": [
        {
          "이름": "기획력",
          "액션": [
            { "행동": "오늘 하루 가장 인상 깊었던 아이디어 1줄 요약", "설명": "생각을 명확하게 정리하는 훈련", "시간": "5분" },
            { "행동": "관심 있는 분야의 서비스/프로젝트 1개 분석", "설명": "관찰력과 구조화 훈련", "시간": "15~20분" }
          ]
        },
        {
          "이름": "창의력",
          "액션": [
            { "행동": "Pinterest에서 '영감 폴더' 만들기", "설명": "시각적 창의력 자극", "시간": "10분" }
          ]
        }
      ],
      "핵심팁": "실행을 방해하지 않는 수준의 작음이 중요. 하루 10분이면 할 수 있어요.",
      "추천루틴": [
        { "시간대": "오전", "내용": "기획 아이디어 1줄 쓰기", "툴": "Notion / 메모" },
        { "시간대": "오후", "내용": "콘텐츠 1개 기획 분석", "툴": "Notion" },
        { "시간대": "밤", "내용": "좋아하는 콘텐츠 스크랩 + 한줄 평", "툴": "Pinterest / YouTube + 메모" }
      ]
    }

     중요: 액션리스트의 각 key는 반드시 감정명(이름)과 정확히 일치해야 하며,
      각 감정의 value는 반드시 아래와 같은 구조여야 해.

      "액션리스트": {
        "불안": {
          "카테고리": [
            {
              "이름": "카테고리명",
              "액션": [
                { "행동": "행동명", "설명": "설명", "시간": "예상 소요 시간" }
              ]
            }
          ],
          "핵심팁": "핵심 팁",
          "추천루틴": [
            { "시간대": "아침", "내용": "루틴 내용", "툴": "사용 툴" }
          ]
        }
      }
  }
}

    사용자 입력:
    ${text}
    `;

  const response = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    {
      model: "gpt-3.5-turbo",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.7,
    },
    {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
    }
  );

  // 응답에서 JSON 부분만 추출
  const content = response.data.choices[0].message.content;

  try {
    const jsonStart = content.indexOf("{");
    const jsonEnd = content.lastIndexOf("}") + 1;
    const jsonString = content.slice(jsonStart, jsonEnd);
    return JSON.parse(jsonString);
  } catch (e) {
    console.error("파싱 에러:", e, content);
    throw e;
  }
}

export async function getEmotionPolarity(emotion) {
    
    const prompt = `
    너는 매우 섬세한 감정 분석가이자, 기획자다.
    
    아래 사용자의 일기/글에서 느껴지는 감정을 최대 5개까지 추출해줘.
    각 감정마다 반드시 아래 3가지를 모두 포함해서 분석해줘.
    
    1. 감정명(2~3개 단어, 예: 벅참/감동, 존경/동경, 가치에 대한 열망, 자부심, 갈망 등)
    2. 그 감정이 드러나는 대표적인 문장(사용자 글에서 직접 인용, 또는 그 감정이 잘 드러나는 예시 문장)
    3. 그 감정의 본질적 설명(단순한 감정이 아니라, 내면의 상태, 동기, 맥락, 가치관, 전환점 등까지 깊이 있게 분석)
    
    그리고 각 감정에 대해, 아래와 같이 **매우 구체적이고 실천 가능한 액션리스트**를 제안해줘.
    - 감정이 긍정적이면, 그 감정을 극대화할 수 있는 루틴/실천법을, 부정적이면 회복할 수 있는 루틴/실천법을 제안해줘.
    - 액션리스트는 반드시 표 형식(액션/설명/예상 소요 시간)으로 5개 이상 제안해줘.
    - 필요하다면, 감정의 하위 카테고리(예: 기획력/창의력 등)로 나눠서 제안해줘.
    - 마지막에, 하루 루틴 예시와 핵심 팁(실행을 방해하지 않는 작은 실천의 중요성 등)도 꼭 추가해줘.

    아래와 같은 형식으로 JSON으로만 답변해줘:
    
    {
      "감정": [
        {
          "이름": "벅참 / 감동",
          "예시": "“종합예술같은 작품에 심장이 뛴다”",
          "설명": "예술적 또는 창조적 경험에서 오는 감정의 진동. 단순한 흥미가 아니라 깊은 감흥에 가까움."
        },
        {
          "이름": "존경 / 이상에 대한 동경",
          "예시": "“르코르뷔지에, 노스페이스 창업자, 뉴진스..."",
          "설명": "현실을 뛰어넘는 가치를 실현해낸 사람들에 대한 동경과 감탄."
        }
      ],
      "액션리스트": {
    "기획력과 창의력에 대한 갈망": {
      "카테고리": [
        {
          "이름": "기획력",
          "액션": [
            { "행동": "오늘 하루 가장 인상 깊었던 아이디어 1줄 요약", "설명": "생각을 명확하게 정리하는 훈련", "시간": "5분" },
            { "행동": "관심 있는 분야의 서비스/프로젝트 1개 분석", "설명": "관찰력과 구조화 훈련", "시간": "15~20분" }
          ]
        },
        {
          "이름": "창의력",
          "액션": [
            { "행동": "Pinterest에서 '영감 폴더' 만들기", "설명": "시각적 창의력 자극", "시간": "10분" }
          ]
        }
      ],
      "핵심팁": "실행을 방해하지 않는 수준의 작음이 중요. 하루 10분이면 할 수 있어요.",
      "추천루틴": [
        { "시간대": "오전", "내용": "기획 아이디어 1줄 쓰기", "툴": "Notion / 메모" },
        { "시간대": "오후", "내용": "콘텐츠 1개 기획 분석", "툴": "Notion" },
        { "시간대": "밤", "내용": "좋아하는 콘텐츠 스크랩 + 한줄 평", "툴": "Pinterest / YouTube + 메모" }
      ]
    }
  }
}

    
    사용자 입력:
    ${text}
    `;


  const response = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    {
      model: "gpt-3.5-turbo",
      messages: [{ role: "user", content: prompt }],
      temperature: 0,
    },
    {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
    }
  );

  const content = response.data.choices[0].message.content.trim();
  if (content.includes("긍정")) return 1;
  if (content.includes("부정")) return -1;
  return 0; // 중립
}